parameters:
  - name: account_name
    type: string
  - name: account_key
    type: string
  - name: account_type
    type: string
  - name: container
    type: string
  - name: temp_dir
    type: string
  - name: mount_dir
    type: string  
  - name: block_size
    type: number  


steps:  
  - script:
      AZURE_STORAGE_ACCOUNT=${{ parameters.account_name }}
      AZURE_STORAGE_ACCESS_KEY=${{ parameters.account_key }}
      echo "##vso[task.setvariable variable=AZURE_STORAGE_ACCOUNT]$AZURE_STORAGE_ACCOUNT"
      echo "##vso[task.setvariable variable=AZURE_STORAGE_ACCESS_KEY]$AZURE_STORAGE_ACCESS_KEY"
    displayName: 'Export Creds'

  - script:
      echo $AZURE_STORAGE_ACCOUNT
    displayName: "Validate Env"
    
  - template: 'mount.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}
      prefix: "DataIntegrity"
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount ${{ parameters.mount_dir }} --default-working-dir=$(WORK_DIR) --block-cache --block-cache-block-size=${{ parameters.block_size }} --container-name=${{ parameters.container }}

  - script: |
      $(WORK_DIR)/blobfuse2 unmount all
    displayName: 'Unmount Blobfuse2'

  - template: 'cleanup.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}